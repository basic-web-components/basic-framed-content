<!--
When this is placed on a page framed by a basic-autosize-iframe element, the
two elements will cooperate to ensure the outer element can automatically adjust
to the size of the contents of the inner element.

The two elements communicate with postMessage, which is not supportedy by IE10.
-->

<link rel="import" href="../polymer/polymer.html">

<polymer-element name="basic-framed-content">

<template>
  <style>
  :host {
    display: block;
  }
  </style>
  <content></content>
</template>

<script>
Polymer( "basic-framed-content", {

  broadcastContent: function() {
    // Our own height isn't available immediately; wait a tick to give ourselves
    // a chance to render.
    window.setTimeout( function() {
      var height = Math.ceil( this.offsetHeight );
      window.parent.postMessage({
        height: height,
        message: "framedContentChanged",
        content: this.innerHTML
      }, "*" );
    }.bind( this ), 1 );
  },

  contentChanged: function() {
    this.broadcastContent();
  },

  ready: function() {

    window.addEventListener( "polymer-ready", function() {
      window.parent.postMessage( "framedPolymerReady", "*" );
    }.bind( this ));

    window.addEventListener( "message", function( event ) {
      if ( !event.data ) {
        return;
      }
      switch ( event.data.message ) {
        case "setContent":
          this.innerHTML = event.data.content;
          // Promote any links to document head.
          var links = this.querySelectorAll( "link" );
          Array.prototype.forEach.call( links, function( link ) {
            document.head.appendChild( link );
          });
          break;

        case "broadcastContent":
          this.broadcastContent();
          break;
      }
    }.bind( this ));

    var observer = new MutationObserver( function() {
      this.contentChanged();
    }.bind( this ));
    // Unlike a typical basic-element, we also want to observe attribute changes.
    observer.observe( this, {
      attributes: true,
      characterData: true,
      childList: true,
      subtree: true
    });
    this.contentChanged();

  }

});
</script>
</polymer-element>
